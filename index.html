<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Foreign workers in the US</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-64459548-1', 'auto');
      ga('send', 'pageview');
    </script>
		<style>
		path {
		  fill: none;
		  stroke-linejoin: round;
		}
		
		.land {
		  fill: #ddd;
		}
		
		.states,
		.hexagons path {
		  stroke: #fff;
		}
		
		.bar {
			fill: steelblue;
		}
		.bar:hover {
			fill: brown;
		}
		.axis {
			font: 9px sans-serif;
		}
	  .axis path,
	  .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}
		.x.axis path {
			display: none;
		}
		.chart rect {
			fill: steelblue;
		}
	
		.chart rect:hover {
			fill: brown;
		}
	
		.chart text {
			fill: white;
			font: 10px sans-serif;
			text-anchor: end;
		}
	
		.tick text {
			fill: black;
		}
	  </style>
  </head>
	<body>
    <div class="wrapper">
      <header>
        <h1>Kelvin Tran</h1>
        <p>
        <img src="https://raw.githubusercontent.com/kelvin-tran/kelvin-tran.github.io/master/static/profile.jpg" style="width:140px;height:140px;border-radius: 10px;">
        </p>
        <p>I am a lawyer, but I do <a href="http://kelvin-tran.github.io/">other things</a></p>
        <p class="view"><a href="http://github.com/kelvin-tran">GitHub</a> | <a href="http://twitter.com/_kelvintran">Twitter</a> | <a href="https://au.linkedin.com/in/kelvintran">LinkedIn</a></p>
        <div>
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <!-- Kelvin Tran GitHub pages index -->
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-8039812474190322"
               data-ad-slot="3954668498"
               data-ad-format="auto"></ins>
          <script>
          	(adsbygoogle = window.adsbygoogle || []).push({});
        	</script>
        </div>
      </header>
      <section>
				<h1>Foreign workers in the US</h1>
				<p><em>View the <a href="http://github.com/kelvin-tran/foreign-lawyers/">source of this content</a>.</em></p>
				<p>By contrast to the rest of the modern world, lawyers seem to care very little about data, maybe apart from the field of <a href="http://www.justice.gov/atr/public/guidelines/hhi.html">competition/antitrust law</a> and say, the sentencing of criminals.  But we should care because, amongst other things, it can be used as evidence support an argument.  I'm thinking along the lines of nationwide data about hiring practices in discrmination cases.</p>
				<p>Because manipulating data will matter for lawyers one day, I've learned how to use D3.js, which is a data visualisation library that even the <a href="http://www.nytimes.com/interactive/2015/04/20/upshot/missing-black-men.html?abt=0002&abg=1&_r=3">New York Times</a> uses.</p>
				<p>In this post, I look at data published by the US agency responsible for managing working visas about the applications it receives.  The data contains, for each application, information about the employer, the job title, location of work and the employee's salary(!), amongst other things.  The data is clean but not pretty.  And there are 510,000 plus rows.  This what it looks like (in csv format):</p>
				<pre><code>LCA_CASE_NUMBER,STATUS,LCA_CASE_SUBMIT,DECISION_DATE,VISA_CLASS,LCA_CASE_EMPLOYMENT_START_DATE,LCA_CASE_EMPLOYMENT_END_DATE,LCA_CASE_EMPLOYER_NAME,LCA_CASE_EMPLOYER_ADDRESS,LCA_CASE_EMPLOYER_CITY,LCA_CASE_EMPLOYER_STATE,LCA_CASE_EMPLOYER_POSTAL_CODE,LCA_CASE_SOC_CODE,LCA_CASE_SOC_NAME,LCA_CASE_JOB_TITLE,LCA_CASE_WAGE_RATE_FROM,LCA_CASE_WAGE_RATE_TO,LCA_CASE_WAGE_RATE_UNIT,FULL_TIME_POS,TOTAL_WORKERS,LCA_CASE_WORKLOC1_CITY,LCA_CASE_WORKLOC1_STATE,PW_1,W_UNIT_1, PW_SOURCE_1,OTHER_WAGE_SOURCE_1,YR_SOURCE_PUB_1,LCA_CASE_WORKLOC2_CITY,LCA_CASE_WORKLOC2_STATE,PW_2,PW_UNIT_2,PW_SOURCE_2,OTHER_WAGE_SOURCE_2,YR_SOURCE_PUB_2,LCA_CASE_NAICS_CODE
I-203-14042-820159,CERTIFIED,11/02/2014,18/02/2014,E-3 Australian,1/04/2014,31/03/2016,"ACUMATICA INC 4030 LAKE WASHINGTON BLVD KIRKLAND WA 98033",11-2021,Marketing Managers,VICE PRESIDENT - PARTNER STRATEGY,300000,,Year,Y,1,KIRKLAND,WA,134597.00,Year,OES,OFLC ONLINE DATA CENTER,2013,,,,,,,,511210,</code></pre>
				<p>Let's look at wages earned by foreign lawyers.  With a few lines of code and minimal competence in MS Excel, we can group the wages of lawyers employed on a full-time basis and plot a frequency distribution (see Figure 1).</p>
				<div id='all-lawyer-wages'></div>
				<p><em>Figure 1.  Foreign lawyers seem to be doing alright for themselves.</em></p>
				<p>Because I'm Australian, let's look at salaries earned by Australians working on a full-time basis (see Figure 2).  Because Australians are entitled to a separate visa class, the E-3, it's possible to separate Australians from other nationalities.</p>
				<div id='aus-wages'></div>
				<p><em>Figure 2.  Ok, these guys are killing it - how do I get an E-3 visa?.</em></p>
				<p>Finally, where are Australians working?  I suspect New York and California are up there, but what about the other states?  To sort this out, we can grid the US into hexagons and map each employee to a hexagonal bin.  The result is the hexbin map in Figure 3.</p>
				<div id='hexbin-map'></div>
				<p><em>Figure 3.  What's going on in Washington and Texas?</em></p>
				<p>To find out about Washington (Figure 4) and Texas (Figure 5), we isolated the applications from employers in those states.</p>
				<div id="wash-chart"></div>
				<p><em>Figure 4.  Turns out its mainly tech employees (Amazon, Microsoft together employ about 250 Australians on E-3s in Washington.)</em></p>
				<div id="texas-chart"></div>
				<p><em>Figure 5.  And engineers in Texas - which I should've guessed given the focus on energy there.</em></p>
				<p>Let's close this out with a graph of the professions in which more than 100 Australians are employed in the US.</p>
				<div id="prof-chart"></div>
				<p><em>Figure 6.  No surprises here really.</em></p>
				<p>I hope you enjoyed reading - you can learn more about visualising data in D3.js <a href="http://d3js.org/">here</a>.</p>
      </section>
      <div>
				<footer>
					<p>This page is maintained by <a href="http://github.com/kelvin-tran">Kelvin Tran</a></p>
					<p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
				</footer>
			</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="javascripts/hexbin.min.js"></script>
    <script src="javascripts/scale.fix.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
		<script>
			// lawyer wages graph
			var margin = {top: 20, right: 10, bottom: 80, left: 30},
					width = 500 - margin.left - margin.right,
					height = 350 - margin.top - margin.bottom;
			var y = d3.scale.linear()
					.range([height, 0]);
			var yAxis = d3.svg.axis()
					.scale(y)
					.orient("left");
			var svg = d3.select("#all-lawyer-wages").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/lawyer-wages.csv", type, function(error, data) {
					if (error) throw error;
					var x = d3.scale.ordinal()
							.domain(data.map(function(d) { return d.salary; }))
							.rangeRoundBands([0, width], .1);
					var xAxis = d3.svg.axis()
							.scale(x)
							.tickValues(x.domain().filter(function(d, i) { return !(i % 2); }))
							.orient("bottom");
					y.domain([0, d3.max(data, function(d) { return d.count; })]);
					svg.append("g")
							.attr("class", "x axis")
							.attr("transform", "translate(0," + height + ")")
						.call(xAxis)
						.selectAll("text")  
							.style("text-anchor", "end")
							.attr("dx", "-.8em")
							.attr("dy", ".15em")
							.attr("transform", function(d) {
								return "rotate(-55)" 
							});
					svg.append("g")
							.attr("class", "y axis")
						.call(yAxis)
			    	.append("text")
							.attr("transform", "rotate(-90)")
							.attr("y", 6)
							.attr("dy", ".71em")
							.style("text-anchor", "end")
						.text("Number of foreign lawyers");
					svg.selectAll(".bar")
						.data(data)
						.enter().append("rect")
							.attr("class", "bar")
							.attr("x", function(d) { return x(d.salary); })
							.attr("width", x.rangeBand())
							.attr("y", function(d) { return y(d.count); })
							.attr("height", function(d) { return height - y(d.count); });
			});
			function type(d) {
				d.salary = '$' + d.salary.replace('000-', '-').replace(new RegExp('000$'), 'k');
				d.count = +d.count;
				return d;
			}
		</script>
		<script>
			// australian wages
			var aus_margin = {top: 20, right: 10, bottom: 80, left: 30},
			    aus_width = 500 - aus_margin.left - aus_margin.right,
			    aus_height = 350 - aus_margin.top - aus_margin.bottom;
			var aus_y = d3.scale.linear()
			    .range([aus_height, 0]);
			var aus_yAxis = d3.svg.axis()
			    .scale(aus_y)
			    .orient("left");
			var aus_svg = d3.select("#aus-wages").append("svg")
			    .attr("width", aus_width + aus_margin.left + aus_margin.right)
			    .attr("height", aus_height + aus_margin.top + aus_margin.bottom)
			  .append("g")
			    .attr("transform", "translate(" + aus_margin.left + "," + aus_margin.top + ")");
			d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/aus-wages.csv", type, function(error, data) {
			  if (error) throw error;
				var aus_x = d3.scale.ordinal()
						.domain(data.map(function(d) { return d.salary; }))
						.rangeRoundBands([0, aus_width], .1);
				var aus_xAxis = d3.svg.axis()
				    .scale(aus_x)
				    .tickValues(aus_x.domain().filter(function(d, i) { return !(i % 2); }))
				    .orient("bottom");
			  aus_y.domain([0, d3.max(data, function(d) { return d.count; })]);
			  aus_svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + aus_height + ")")
						.call(aus_xAxis)
						.selectAll("text")  
						.style("text-anchor", "end")
						.attr("dx", "-.8em")
						.attr("dy", ".15em")
						.attr("transform", function(d) {
							return "rotate(-55)" 
						});
			  aus_svg.append("g")
						.attr("class", "y axis")
						.call(aus_yAxis)
			    .append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", 6)
						.attr("dy", ".71em")
						.style("text-anchor", "end")
						.text("Number of Aus workers");
			  aus_svg.selectAll(".bar")
						.data(data)
			    .enter().append("rect")
						.attr("class", "bar")
						.attr("x", function(d) { return aus_x(d.salary); })
						.attr("width", aus_x.rangeBand())
						.attr("y", function(d) { return aus_y(d.count); })
						.attr("height", function(d) { return height - aus_y(d.count); });
			});
			function type(d) {
			  d.salary = '$' + d.salary.replace('000-', '-').replace(new RegExp('000$'), 'k');
			  d.count = +d.count;
			  return d;
			}
		</script>
		<script>
			//Width and height
			//var choro_w = 500;
			//var choro_h = 380;
			//Define map projection
			//var choro_projection = d3.geo.albersUsa()
			//	.translate([choro_w/2, choro_h/2])
			//	.scale([600]);
			//Define path generator
			//var choro_path = d3.geo.path()
			//	.projection(choro_projection);
							 
			//Define scale to sort data values into buckets of color
			//var choro_color = d3.scale.pow().exponent(.9)
			//	.range(['rgb(247,251,255)','rgb(222,235,247)','rgb(198,219,239)','rgb(158,202,225)','rgb(107,174,214)','rgb(66,146,198)','rgb(33,113,181)','rgb(8,81,156)','rgb(8,48,107)']);
			//Create SVG element
			//var choro_svg = d3.select("#map")
			//	.append("svg")
			//	.attr("width", choro_w)
			//	.attr("height", choro_h);
			//Load in agriculture data
			//d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/aus-states.csv", function(data) {
				//Set input domain for color scale
			//	choro_color.domain([
			//		d3.min(data, function(d) { return d.value; }), 
			//		d3.max(data, function(d) { return d.value; })
			//	]);
				//Load in GeoJSON data
			//	d3.json("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/us-states.json", function(json) {
					//Merge the ag. data and GeoJSON
					//Loop through once for each ag. data value
			//		for (var i = 0; i < data.length; i++) {
						//Grab state name
			//			var dataState = data[i].state;
						//Grab data value, and convert from string to float
			//			var dataValue = parseFloat(data[i].value);
						//Find the corresponding state inside the GeoJSON
			//			for (var j = 0; j < json.features.length; j++) {
			//				var jsonState = json.features[j].properties.name;
			//				if (dataState == jsonState) {
								//Copy the data value into the JSON
			//					json.features[j].properties.value = dataValue;
								//Stop looking through the JSON
			//					break;
			//				}
			//			}		
			//		}
					//Bind data and create one path per GeoJSON feature
			//		choro_svg.selectAll("path")
			//				.data(json.features)
			//				.enter()
			//				.append("path")
			//					.attr("d", choro_path)
			//					.style("fill", function(d) {
									//Get data value
			//						var value = d.properties.value;
			//						if (value) {
									  //If value exists…
			//						  return choro_color(value);
			//						} else {
									  //If value is undefined…
			//						  return "#ccc";
			//						}
			//					});
			//	});
			//});
		</script>
		<script>
		var tx_margin = {right: 10, bottom: 30, left: 250},
				tx_width = 500 - tx_margin.left - tx_margin.right,
				tx_barHeight = 20;
		var tx_x = d3.scale.linear()
				.range([0, tx_width]);
		var tx_xAxis = d3.svg.axis()
				.scale(tx_x)
				.orient("bottom");
		d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/TX.csv", type, function(error, data) {
			var tx_height = tx_barHeight * data.length + tx_margin.bottom;
			var tx_chart = d3.select("#texas-chart").append("svg")
					.attr("class", "chart")
					.attr("width", tx_width + tx_margin.left + tx_margin.right)
					.attr("height", tx_height)
				.append("g")
					.attr("transform", "translate(" + tx_margin.left + ",0)");
			var tx_y = d3.scale.ordinal()
					.domain(data.map(function(d) { return d.profession; }))
					.rangeBands([0, tx_barHeight * data.length]);
			var tx_yAxis = d3.svg.axis()
					.scale(tx_y)
					.orient("left");
		  tx_x.domain([0, d3.max(data, function(d) { return d.value; })]);
			tx_chart.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + (tx_height - tx_margin.bottom) + ")")
				.call(tx_xAxis)
			tx_chart.append("g")
					.attr("class", "y axis")
				.call(tx_yAxis)
		  var tx_bar = tx_chart.selectAll("rect")
					.data(data)
				.enter().append("g")
					.attr("transform", function(d, i) { return "translate(0," + i * tx_barHeight + ")"; });
			tx_bar.append("rect")
					.attr("width", function(d) { return tx_x(d.value); })
					.attr("height", tx_barHeight - 1);
		});
		function type(d) {
			if (d.value > 15) {
			d.value = +d.value; // coerce to number
			return d;
			}
		};
		</script>
		<script>
		var wa_margin = {right: 10, bottom: 30, left: 250},
				wa_width = 500 - wa_margin.left - wa_margin.right,
				wa_barHeight = 20;
		var wa_x = d3.scale.linear()
				.range([0, wa_width]);
		var wa_xAxis = d3.svg.axis()
				.scale(wa_x)
				.orient("bottom");
		d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/WA.csv", type, function(error, data) {
			var wa_height = wa_barHeight * data.length + wa_margin.bottom;
			var wa_chart = d3.select("#wash-chart").append("svg")
					.attr("class", "chart")
					.attr("width", wa_width + wa_margin.left + wa_margin.right)
					.attr("height", wa_height)
				.append("g")
					.attr("transform", "translate(" + wa_margin.left + ",0)");
			var wa_y = d3.scale.ordinal()
					.domain(data.map(function(d) { return d.profession; }))
					.rangeBands([0, wa_barHeight * data.length]);
			var wa_yAxis = d3.svg.axis()
					.scale(wa_y)
					.orient("left");
		  wa_x.domain([0, d3.max(data, function(d) { return d.value; })]);
			wa_chart.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + (wa_height - wa_margin.bottom) + ")")
				.call(wa_xAxis)
			wa_chart.append("g")
					.attr("class", "y axis")
				.call(wa_yAxis)
		  var wa_bar = wa_chart.selectAll("rect")
					.data(data)
				.enter().append("g")
					.attr("transform", function(d, i) { return "translate(0," + i * wa_barHeight + ")"; });
			wa_bar.append("rect")
					.attr("width", function(d) { return wa_x(d.value); })
					.attr("height", wa_barHeight - 1);
		});
		function type(d) {
			if (d.value > 10) {
			d.value = +d.value; // coerce to number
			return d;
			}
		};
		</script>
		<script>
		var aus_prof_margin = {right: 10, bottom: 30, left: 250},
				aus_prof_width = 500 - aus_prof_margin.left - aus_prof_margin.right,
				aus_prof_barHeight = 20;
		var aus_prof_x = d3.scale.linear()
				.range([0, aus_prof_width]);
		var aus_prof_xAxis = d3.svg.axis()
				.scale(aus_prof_x)
				.orient("bottom");
		d3.csv("https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/australians-professions.csv", type, function(error, data) {
			var aus_prof_height = aus_prof_barHeight * data.length + aus_prof_margin.bottom;
			var aus_prof_chart = d3.select("#prof-chart").append("svg")
					.attr("class", "chart")
					.attr("width", aus_prof_width + aus_prof_margin.left + aus_prof_margin.right)
					.attr("height", aus_prof_height)
				.append("g")
					.attr("transform", "translate(" + aus_prof_margin.left + ",0)");
			var aus_prof_y = d3.scale.ordinal()
					.domain(data.map(function(d) { return d.profession; }))
					.rangeBands([0, aus_prof_barHeight * data.length]);
			var aus_prof_yAxis = d3.svg.axis()
					.scale(aus_prof_y)
					.orient("left");
		  aus_prof_x.domain([0, d3.max(data, function(d) { return d.value; })]);
			aus_prof_chart.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + (aus_prof_height - aus_prof_margin.bottom) + ")")
				.call(aus_prof_xAxis)
			aus_prof_chart.append("g")
					.attr("class", "y axis")
				.call(aus_prof_yAxis)
		  var aus_prof_bar = aus_prof_chart.selectAll("rect")
					.data(data)
				.enter().append("g")
					.attr("transform", function(d, i) { return "translate(0," + i * aus_prof_barHeight + ")"; });
			aus_prof_bar.append("rect")
					.attr("width", function(d) { return aus_prof_x(d.value); })
					.attr("height", aus_prof_barHeight - 1);
		});
		function type(d) {
			if (d.value > 100) {
			d.value = +d.value; // coerce to number
			return d;
			}
		};
		</script>
		<script>
		
		var hex_width = 640,
				hex_height = 333;
		
		var hex_color = d3.scale.linear()
				//.domain([40200, 400000])
				.range(['rgb(247,252,240)','rgb(224,243,219)','rgb(204,235,197)','rgb(168,221,181)','rgb(123,204,196)','rgb(78,179,211)','rgb(43,140,190)','rgb(8,104,172)','rgb(8,64,129)']);
		
		var hexbin = d3.hexbin()
				.size([hex_width, hex_height])
				.radius(6);
		
		var hex_radius = d3.scale.sqrt()
				.domain([1, 162])
				.range([0, 6]);
		
		var hex_projection = d3.geo.albers()
				.scale(667)
				.translate([hex_width / 2, hex_height / 2])
				.precision(.1);
		
		var hex_path = d3.geo.path()
				.projection(hex_projection);
		
		var hex_svg = d3.select("#hexbin-map").append("svg")
				.attr("width", hex_width)
				.attr("height", hex_height);
		
		queue()
				.defer(d3.json, "https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/us.json")
				.defer(d3.csv, "https://raw.githubusercontent.com/kelvin-tran/foreign-lawyers/master/aus_latlng.csv")
				.await(ready);
		
		function ready(error, us, jobs) {
			if (error) throw error;
		
				jobs.forEach(function(d) {
					var p = hex_projection(d);
					d[0] = p[0],
					d[1] = p[1],
					d.salary = +d.salary;
				});
		
				hex_svg.append("path")
					.datum(topojson.feature(us, us.objects.land))
					.attr("class", "land")
					.attr("d", hex_path);
		
				hex_svg.append("path")
					.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
					.attr("class", "states")
					.attr("d", hex_path);
		
				hex_svg.append("g")
					.attr("class", "hexagons")
		    .selectAll("path")
					.data(hexbin(jobs).sort(function(a, b) { return b.length - a.length; }))
		    .enter().append("path")
					.attr("d", function(d) { return hexbin.hexagon(hex_radius(d.length)); })
					.style("fill", function(d) {
						console.log(hex_color(d3.median(d, function(d) {
							return +d.salary; 
						})));
						return hex_color(d3.median(d, function(d) {
							return +d.salary; 
						})); 
					})
					.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
					//.style("fill", "steelblue")
					;
		}
		
		</script>
	</body>
</html>
